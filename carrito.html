<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras | Urban Girl Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos CSS para el control de cantidad */
        .qty-control {
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: fit-content;
            margin: auto;
        }
        .qty-control button {
            background: none;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .qty-control .qty-display {
            padding: 0 10px;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            min-width: 20px;
            text-align: center;
        }
        /* Estilo para el bot√≥n de eliminar */
        .remove-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .remove-btn:hover {
            background-color: #d32f2f;
        }
        /* Estilos de la tabla */
        .cart-items table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .cart-items th, .cart-items td {
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        .cart-item-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }
        .item-info {
            display: flex;
            align-items: center;
        }
        .item-info h4 {
            margin: 0;
            font-size: 1em;
        }
        /* Estilo para los mensajes de stock/reserva */
        .stock-messages small {
            display: block;
            font-size: 0.85em;
            margin-top: 2px;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo">
            <a href="index.html"> 
                <h1>Urban Girl Shop</h1>
            </a>
        </div>
        <nav class="main-nav">
            <a href="index.html">Inicio</a>
            <a href="#novedades">Novedades</a>
            <a href="#vestidos">Vestidos</a>
            <a href="carrito.html" class="cart-button" style="background-color: var(--color-acento-rosa);">
                üõçÔ∏è Carrito (<span id="cart-count-header">0</span>) 
            </a>
        </nav>
        <div class="header-actions">
        </div>
    </header>

    <main class="cart-page-content">

        <h2>üõçÔ∏è Tu Carrito de Compras</h2>
        
        <div class="cart-container">
            
            <section class="cart-items">
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th></th> 
                        </tr>
                    </thead>
                    <tbody id="cart-table-body">
                        </tbody>
                </table>
                
                <div class="cart-actions-bottom">
                    <a href="index.html" class="continue-shopping-btn">‚Üê Seguir Comprando</a>
                    <button class="update-cart-btn" style="display: none;">Actualizar Carrito</button>
                </div>
            </section>

            <aside class="cart-summary">
                <h3>Resumen del Pedido</h3>
                <div class="summary-line">
                    <span>Subtotal:</span>
                    <span><span id="subtotal-amount">$0 CLP</span></span>
                </div>
                <div class="summary-line">
                    <span>Descuento (Cup√≥n):</span>
                    <span class="discount-amount">-$0 CLP</span>
                </div>
                <div class="summary-line shipping">
                    <span>Costo de Env√≠o:</span>
                    <span>$5.000 CLP</span>
                </div>
                
                <div class="summary-total">
                    <h4>Total a Pagar:</h4>
                    <span><span id="total-amount">$0 CLP</span></span>
                </div>
                
                <button id="finalizar-compra-btn" class="checkout-btn" disabled>Finalizar Compra</button>
                <p class="taxes-note">Impuestos incluidos</p>
                <div id="reservation-timer" style="margin-top: 15px; font-weight: bold; color: green; text-align: center;">A√±ade productos para activar la reserva.</div>
            </aside>
            
        </div>
        
    </main>

    <footer>
        <p>&copy; 2025 **Urban Girl Shop**. Moda Femenina Joven y Contempor√°nea.</p>
        <div class="footer-links">
            <a href="#">Contacto</a> |
            <a href="#">Informaci√≥n de Pago y Boletas</a> |
            <a href="#">Pol√≠tica de Devoluci√≥n</a>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===============================================
            // 1. DATA SETUP
            // ===============================================

            const SHIPPING_COST = 5000; 
            const RESERVATION_TIME = 40; // <--- AUMENTADO A 40 SEGUNDOS
            let reservationInterval; 

            // SKUs corregidos para coincidir con index.html
            const productData = {
                'SKU-0001': { name: 'Blusa de Gasa Rosa Beb√©', price: 25000, img: 'blusa.jpg' }, 
                'SKU-0002': { name: 'Falda Plisada Menta', price: 32990, img: 'falda.jpg' }, 
                'SKU-0003': { name: 'Vestido de Lino Liviano', price: 45000, img: 'vestido.jpg' }, 
                'SKU-0004': { name: 'Mini Bolso Cruzado', price: 18500, img: 'img/placeholder-4.jpg' }
            };

            // Cargar carrito y stock desde sessionStorage
            let cart = JSON.parse(sessionStorage.getItem('shoppingCart')) || {};
            let currentStock = JSON.parse(sessionStorage.getItem('productStock')) || {}; 
            
            const tableBody = document.getElementById('cart-table-body');
            const subtotalSpan = document.getElementById('subtotal-amount');
            const totalSpan = document.getElementById('total-amount');
            const headerCountSpan = document.getElementById('cart-count-header');
            const timerDiv = document.getElementById('reservation-timer');
            const checkoutButton = document.getElementById('finalizar-compra-btn');

            // ===============================================
            // 2. L√ìGICA DE RESERVA Y TEMPORIZADOR
            // ===============================================
            
            function startReservationTimer() {
                clearInterval(reservationInterval); 
                sessionStorage.setItem('reservationStart', Date.now());

                const reservationEndTime = Date.now() + RESERVATION_TIME * 1000;

                function updateTimer() {
                    const timeLeft = Math.floor((reservationEndTime - Date.now()) / 1000);

                    if (timeLeft <= 0) {
                        clearInterval(reservationInterval);
                        timerDiv.textContent = '‚õî Tiempo de reserva agotado. Productos devueltos al stock.';
                        timerDiv.style.color = 'red';
                        handleExpiration();
                        return;
                    }

                    timerDiv.textContent = `‚úÖ Productos reservados: ${timeLeft} segundos restantes.`;
                    timerDiv.style.color = 'green';
                }

                updateTimer(); 
                reservationInterval = setInterval(updateTimer, 1000);
            }

            function handleExpiration() {
                if (Object.keys(cart).length > 0) {
                    for (const productId in cart) {
                        const qty = cart[productId];
                        currentStock[productId] = (currentStock[productId] || 0) + qty;
                    }
                    cart = {}; 
                    updateStorage();
                    renderCart();
                }
            }

            function handleCheckout() {
                clearInterval(reservationInterval);
                sessionStorage.removeItem('reservationStart');
                alert('¬°Compra finalizada con √©xito! Gracias por tu pedido.');
                
                cart = {};
                updateStorage();
                renderCart();
            }

            // ===============================================
            // 3. HANDLERS Y UTILS
            // ===============================================
            
            function formatCLP(amount) {
                return `$${amount.toLocaleString('es-CL')} CLP`;
            }

            function updateStorage() {
                sessionStorage.setItem('shoppingCart', JSON.stringify(cart));
                sessionStorage.setItem('productStock', JSON.stringify(currentStock));
                
                const totalItems = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
                if (headerCountSpan) {
                    headerCountSpan.textContent = totalItems;
                }
            }

            function handleQuantityChange(productId, delta) {
                const product = productData[productId];
                if (!product) return;

                const currentCartQty = cart[productId] || 0;
                const newCartQty = currentCartQty + delta;
                
                if (delta > 0) { 
                    if ((currentStock[productId] || 0) > 0) {
                        cart[productId] = newCartQty;
                        currentStock[productId] -= 1; 
                        startReservationTimer();
                    } else {
                        alert(`¬°No hay m√°s stock disponible de ${product.name} para agregar!`);
                        return;
                    }
                } else if (delta < 0) { 
                    if (newCartQty >= 1) {
                        cart[productId] = newCartQty;
                        currentStock[productId] += 1; 
                        startReservationTimer();
                    } else {
                        handleRemove(productId);
                        return;
                    }
                }

                updateStorage();
                renderCart(); 
            }

            function handleRemove(productId) {
                const qtyToRemove = cart[productId] || 0;
                
                if (qtyToRemove > 0) {
                    currentStock[productId] = (currentStock[productId] || 0) + qtyToRemove;
                    delete cart[productId]; 
                    startReservationTimer();
                }

                updateStorage();
                renderCart();
            }

            // ===============================================
            // 4. RENDERIZADO DEL CARRITO
            // ===============================================

            function renderCart() {
                tableBody.innerHTML = ''; 
                let subtotal = 0;
                let totalItems = 0;

                for (const productId in cart) {
                    const qty = cart[productId];
                    
                    if (qty > 0) {
                        const product = productData[productId];
                        if (!product) continue;

                        const itemTotal = product.price * qty;
                        subtotal += itemTotal;
                        totalItems += qty;
                        
                        const availableStock = currentStock[productId] || 0;
                        
                        // Generaci√≥n de los mensajes de stock/reserva (Punto solicitado)
                        let stockMessages = '<div class="stock-messages">';
                        stockMessages += `<small style="color: green; font-weight: bold;">‚úÖ ${qty} unidad(es) reservada(s).</small>`;

                        if (availableStock === 0) {
                            stockMessages += `<small style="color: red;">‚ùå Agotado. No se pueden a√±adir m√°s.</small>`;
                        } else {
                            const color = availableStock <= 5 ? 'orange' : '#007bff'; // Azul si hay mucho stock
                            stockMessages += `<small style="color: ${color};">Stock disponible para a√±adir: ${availableStock}</small>`;
                        }
                        stockMessages += '</div>';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="item-info">
                                <img src="${product.img}" alt="${product.name}" class="cart-item-img">
                                <div>
                                    <h4>${product.name}</h4>
                                    <small>SKU: ${productId}</small>
                                    ${stockMessages} </div>
                            </td>
                            <td>${formatCLP(product.price)}</td>
                            <td>
                                <div class="qty-control">
                                    <button class="qty-btn" data-product-id="${productId}" data-delta="-1" title="Quitar 1">-</button>
                                    <span class="qty-display">${qty}</span>
                                    <button class="qty-btn" data-product-id="${productId}" data-delta="+1" title="A√±adir 1" ${availableStock <= 0 ? 'disabled' : ''}>+</button>
                                </div>
                            </td>
                            <td>${formatCLP(itemTotal)}</td>
                            <td><button class="remove-btn" data-product-id="${productId}">üóëÔ∏è Eliminar</button></td>
                        `;
                        
                        tableBody.appendChild(row);
                    }
                }

                const grandTotal = subtotal + SHIPPING_COST;
                
                subtotalSpan.textContent = formatCLP(subtotal);
                totalSpan.textContent = formatCLP(grandTotal);
                headerCountSpan.textContent = totalItems;
                
                if (totalItems === 0) {
                     tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">Tu carrito est√° vac√≠o. <a href="index.html">¬°Empieza a comprar!</a></td></tr>';
                     subtotalSpan.textContent = formatCLP(0);
                     totalSpan.textContent = formatCLP(SHIPPING_COST); 
                     clearInterval(reservationInterval);
                     timerDiv.textContent = 'A√±ade productos para activar la reserva.';
                     timerDiv.style.color = '#888';
                     checkoutButton.disabled = true;
                } else {
                    // Si hay productos, y no hay temporizador, lo iniciamos
                    if (!reservationInterval) {
                         startReservationTimer();
                    }
                    checkoutButton.disabled = false;
                }

                // A√±adir Listeners din√°micamente
                document.querySelectorAll('.qty-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.getAttribute('data-product-id');
                        const delta = parseInt(e.target.getAttribute('data-delta')); 
                        handleQuantityChange(id, delta);
                    });
                });

                document.querySelectorAll('.remove-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.getAttribute('data-product-id');
                        handleRemove(id);
                    });
                });
            }
            
            checkoutButton.addEventListener('click', handleCheckout);

            // 5. Inicializaci√≥n y restauraci√≥n del temporizador
            renderCart();
            
            if (Object.keys(cart).length > 0) {
                const reservationStart = sessionStorage.getItem('reservationStart');
                if (reservationStart) {
                    const timeElapsed = Date.now() - parseInt(reservationStart);
                    const timeRemaining = (RESERVATION_TIME * 1000) - timeElapsed;

                    if (timeRemaining > 0) {
                        startReservationTimer();
                    } else {
                        handleExpiration();
                    }
                } else {
                     startReservationTimer(); 
                }
            }
        });
    </script>
</body>
</html>
